function printSaleReceipt() {
            if (!currentSaleToPrint) return;
            
            // Préparer le contenu du ticket
            const receiptDate = document.getElementById('receipt-date');
            const receiptItems = document.getElementById('receipt-items');
            const receiptTotal = document.getElementById('receipt-total');
            
            receiptDate.textContent = new Date(currentSaleToPrint.date).toLocaleString();
            receiptItems.innerHTML = '';
            
            currentSaleToPrint.items.forEach(item => {
                receiptItems.innerHTML += `
                    <tr>
                        <td style="text-align: left; padding: 5px;">${item.brand} - ${item.name}</td>
                        <td style="text-align: right; padding: 5px;">${item.price.toFixed(2)}€</td>
                    </tr>
                `;
            });
            
            const saleTotal = currentSaleToPrint.items.reduce((total, item) => total + item.price, 0);
            receiptTotal.textContent = `${saleTotal.toFixed(2)}€`;
            
            // Imprimer
            window.print();
        }

        // Export de données
        function exportHistoryCSV() {
            if (salesHistory.length === 0) {
                showToast('Aucune donnée à exporter', 'warning');
                return;
            }
            
            // Préparer les données
            const csvData = [];
            
            // En-têtes
            csvData.push(['Date', 'Heure', 'Marque', 'Cigare', 'Pays', 'Prix']);
            
            // Données
            salesHistory.forEach(sale => {
                const saleDate = new Date(sale.date).toLocaleDateString();
                const saleTime = new Date(sale.date).toLocaleTimeString();
                
                sale.items.forEach(item => {
                    csvData.push([
                        saleDate,
                        saleTime,
                        item.brand,
                        item.name,
                        item.country,
                        item.price.toFixed(2)
                    ]);
                });
            });
            
            // Créer le fichier CSV
            const csv = Papa.unparse(csvData);
            downloadFile(csv, 'historique_ventes.csv', 'text/csv');
        }

        function exportHistoryPDF() {
            if (salesHistory.length === 0) {
                showToast('Aucune donnée à exporter', 'warning');
                return;
            }
            
            // Créer le PDF
            const doc = new jsPDF();
            
            // Titre
            doc.setFontSize(18);
            doc.text('Historique des ventes', 14, 20);
            
            // Date
            doc.setFontSize(12);
            doc.text(`Exporté le ${new Date().toLocaleString()}`, 14, 30);
            
            // Préparer les données
            const tableData = [];
            
            salesHistory.forEach(sale => {
                const saleDate = new Date(sale.date).toLocaleString();
                
                sale.items.forEach(item => {
                    tableData.push([
                        saleDate,
                        item.brand,
                        item.name,
                        item.country,
                        `${item.price.toFixed(2)}€`
                    ]);
                });
            });
            
            // Créer le tableau
            doc.autoTable({
                startY: 40,
                head: [['Date', 'Marque', 'Cigare', 'Pays', 'Prix']],
                body: tableData
            });
            
            // Enregistrer le PDF
            doc.save('historique_ventes.pdf');
        }

        function exportCatalogCSV() {
            if (productCatalog.length === 0) {
                showToast('Aucune donnée à exporter', 'warning');
                return;
            }
            
            // Préparer les données
            const csvData = [];
            
            // En-têtes
            csvData.push(['Marque', 'Cigare', 'Pays', 'Prix']);
            
            // Données
            productCatalog.forEach(product => {
                csvData.push([
                    product.brand,
                    product.name,
                    product.country,
                    product.price.toFixed(2)
                ]);
            });
            
            // Créer le fichier CSV
            const csv = Papa.unparse(csvData);
            downloadFile(csv, 'catalogue_produits.csv', 'text/csv');
        }

        function downloadFile(content, fileName, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Statistiques
        function initializeStatsChart() {
            const ctx = document.getElementById('statsChart').getContext('2d');
            statsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Ventes (€)',
                        data: [],
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function showStats(period) {
            currentStatsPeriod = period;
            
            // Mise à jour du titre
            let title = 'Statistiques';
            switch (period) {
                case 'day':
                    title += ' du jour';
                    break;
                case 'month':
                    title += ' du mois';
                    break;
                case 'year':
                    title += ' de l\'année';
                    break;
            }
            document.getElementById('stats-title').textContent = title;
            
            // Filtrer les données selon la période
            const now = new Date();
            const filteredSales = salesHistory.filter(sale => {
                const saleDate = new Date(sale.date);
                switch (period) {
                    case 'day':
                        return saleDate.getDate() === now.getDate() &&
                               saleDate.getMonth() === now.getMonth() &&
                               saleDate.getFullYear() === now.getFullYear();
                    case 'month':
                        return saleDate.getMonth() === now.getMonth() &&
                               saleDate.getFullYear() === now.getFullYear();
                    case 'year':
                        return saleDate.getFullYear() === now.getFullYear();
                    default:
                        return true;
                }
            });
            
            // Statistiques générales
            let totalSales = filteredSales.length;
            let totalItems = 0;
            let totalAmount = 0;
            
            filteredSales.forEach(sale => {
                totalItems += sale.items.length;
                totalAmount += sale.items.reduce((total, item) => total + item.price, 0);
            });
            
            document.getElementById('statsSalesCount').textContent = totalSales;
            document.getElementById('statsItemsCount').textContent = totalItems;
            document.getElementById('statsTotal').textContent = `${totalAmount.toFixed(2)}€`;
            
            // Préparation des données pour le graphique
            let labels = [];
            let data = [];
            
            if (filteredSales.length > 0) {
                switch (period) {
                    case 'day':
                        // Grouper par heure
                        for (let i = 0; i < 24; i++) {
                            const hour = i.toString().padStart(2, '0') + ':00';
                            labels.push(hour);
                            
                            const hourSales = filteredSales.filter(sale => 
                                new Date(sale.date).getHours() === i
                            );
                            
                            const hourTotal = hourSales.reduce((total, sale) => 
                                total + sale.items.reduce((t, item) => t + item.price, 0)
                            , 0);
                            
                            data.push(hourTotal);
                        }
                        break;
                        
                    case 'month':
                        // Grouper par jour
                        const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                        for (let i = 1; i <= daysInMonth; i++) {
                            labels.push(i.toString());
                            
                            const daySales = filteredSales.filter(sale => 
                                new Date(sale.date).getDate() === i
                            );
                            
                            const dayTotal = daySales.reduce((total, sale) => 
                                total + sale.items.reduce((t, item) => t + item.price, 0)
                            , 0);
                            
                            data.push(dayTotal);
                        }
                        break;
                        
                    case 'year':
                        // Grouper par mois
                        const monthNames = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Août', 'Sep', 'Oct', 'Nov', 'Déc'];
                        for (let i = 0; i < 12; i++) {
                            labels.push(monthNames[i]);
                            
                            const monthSales = filteredSales.filter(sale => 
                                new Date(sale.date).getMonth() === i
                            );
                            
                            const monthTotal = monthSales.reduce((total, sale) => 
                                total + sale.items.reduce((t, item) => t + item.price, 0)
                            , 0);
                            
                            data.push(monthTotal);
                        }
                        break;
                }
            }
            
            // Mise à jour du graphique
            statsChart.data.labels = labels;
            statsChart.data.datasets[0].data = data;
            statsChart.update();
            
            // Top marques et pays
            updateTopItems(filteredSales);
        }

        function updateTopItems(sales) {
            const topBrandsEl = document.getElementById('topBrands');
            const topCountriesEl = document.getElementById('topCountries');
            
            // Compter les occurrences
            const brandCount = {};
            const countryCount = {};
            
            sales.forEach(sale => {
                sale.items.forEach(item => {
                    // Marques
                    if (!brandCount[item.brand]) {
                        brandCount[item.brand] = { count: 0, total: 0 };
                    }
                    brandCount[item.brand].count++;
                    brandCount[item.brand].total += item.price;
                    
                    // Pays
                    if (!countryCount[item.country]) {
                        countryCount[item.country] = { count: 0, total: 0 };
                    }
                    countryCount[item.country].count++;
                    countryCount[item.country].total += item.price;
                });
            });
            
            // Trier et limiter à 5
            const topBrands = Object.entries(brandCount)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 5);
                
            const topCountries = Object.entries(countryCount)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 5);
            
            // Afficher les top marques
            if (topBrands.length === 0) {
                topBrandsEl.innerHTML = `
                    <li class="list-group-item text-center text-muted">
                        Aucune donnée disponible
                    </li>
                `;
            } else {
                topBrandsEl.innerHTML = '';
                topBrands.forEach(([brand, stats]) => {
                    topBrandsEl.innerHTML += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <span class="fw-bold">${brand}</span>
                            </div>
                            <div>
                                <span class="badge bg-primary rounded-pill">${stats.count}</span>
                                <span class="ms-2">${stats.total.toFixed(2)}€</span>
                            </div>
                        </li>
                    `;
                });
            }
            
            // Afficher les top pays
            if (topCountries.length === 0) {
                topCountriesEl.innerHTML = `
                    <li class="list-group-item text-center text-muted">
                        Aucune donnée disponible
                    </li>
                `;
            } else {
                topCountriesEl.innerHTML = '';
                topCountries.forEach(([country, stats]) => {
                    topCountriesEl.innerHTML += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <span class="fw-bold">${country}</span>
                            </div>
                            <div>
                                <span class="badge bg-secondary rounded-pill">${stats.count}</span>
                                <span class="ms-2">${stats.total.toFixed(2)}€</span>
                            </div>
                        </li>
                    `;
                });
            }
        }

        function exportStatsPDF() {
            // Créer le PDF
            const doc = new jsPDF();
            
            // Titre
            doc.setFontSize(18);
            doc.text('Statistiques de vente', 14, 20);
            
            // Période
            let periodText = '';
            switch (currentStatsPeriod) {
                case 'day':
                    periodText = 'du jour';
                    break;
                case 'month':
                    periodText = 'du mois';
                    break;
                case 'year':
                    periodText = 'de l\'année';
                    break;
            }
            
            doc.setFontSize(14);
            doc.text(`Période: ${periodText} (${new Date().toLocaleDateString()})`, 14, 30);
            
            // Récapitulatif
            doc.setFontSize(12);
            doc.text(`Nombre de ventes: ${document.getElementById('statsSalesCount').textContent}`, 14, 45);
            doc.text(`Articles vendus: ${document.getElementById('statsItemsCount').textContent}`, 14, 52);
            doc.text(`Montant total: ${document.getElementById('statsTotal').textContent}`, 14, 59);
            
            // Enregistrer le PDF
            doc.save(`statistiques_${currentStatsPeriod}.pdf`);
        }

        // Gestion du catalogue
        function renderCatalog() {
            const catalogItemsEl = document.getElementById('catalog-items');
            
            if (productCatalog.length === 0) {
                catalogItemsEl.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center">Aucun produit dans le catalogue</td>
                    </tr>
                `;
                return;
            }
            
            catalogItemsEl.innerHTML = '';
            productCatalog.forEach(product => {
                catalogItemsEl.innerHTML += `
                    <tr>
                        <td>${product.brand}</td>
                        <td>${product.name}</td>
                        <td>${product.country}</td>
                        <td>${product.price.toFixed(2)}€</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="generateQRCode('${product.id}')">
                                <i class="fas fa-qrcode"></i> Générer
                            </button>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-secondary me-1" onclick="editProduct('${product.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('${product.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        function addProductToCatalog() {
            const brand = document.getElementById('productBrand').value.trim();
            const name = document.getElementById('productName').value.trim();
            const country = document.getElementById('productCountry').value.trim();
            const price = parseFloat(document.getElementById('productPrice').value);
            
            if (!brand || !name || !country || isNaN(price)) {
                showToast('Veuillez remplir tous les champs', 'danger');
                return;
            }
            
            const newProduct = {
                id: Date.now() + Math.random().toString(36).substr(2, 9),
                brand,
                name,
                country,
                price
            };
            
            productCatalog.push(newProduct);
            saveToLocalStorage();
            renderCatalog();
            
            // Fermer la modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addProductModal'));
            modal.hide();
            
            // Réinitialiser le formulaire
            document.getElementById('addProductForm').reset();
            
            showToast('Produit ajouté avec succès', 'success');
        }

        function editProduct(productId) {
            const product = productCatalog.find(p => p.id === productId);
            
            if (!product) {
                showToast('Produit non trouvé', 'danger');
                return;
            }
            
            // Remplir le formulaire
            document.getElementById('editProductId').value = product.id;
            document.getElementById('editProductBrand').value = product.brand;
            document.getElementById('editProductName').value = product.name;
            document.getElementById('editProductCountry').value = product.country;
            document.getElementById('editProductPrice').value = product.price.toFixed(2);
            
            // Afficher la modal
            const modal = new bootstrap.Modal(document.getElementById('editProductModal'));
            modal.show();
        }

        function updateProduct() {
            const id = document.getElementById('editProductId').value;
            const brand = document.getElementById('editProductBrand').value.trim();
            const name = document.getElementById('editProductName').value.trim();
            const country = document.getElementById('editProductCountry').value.trim();
            const price = parseFloat(document.getElementById('editProductPrice').value);
            
            if (!id || !brand || !name || !country || isNaN(price)) {
                showToast('Veuillez remplir tous les champs', 'danger');
                return;
            }
            
            // Trouver et mettre à jour le produit
            const index = productCatalog.findIndex(p => p.id === id);
            if (index !== -1) {
                productCatalog[index] = {
                    id,
                    brand,
                    name,
                    country,
                    price
                };
                
                saveToLocalStorage();
                renderCatalog();
                
                // Fermer la modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editProductModal'));
                modal.hide();
                
                showToast('Produit mis à jour avec succès', 'success');
            } else {
                showToast('Produit non trouvé', 'danger');
            }
        }

        function deleteProduct(productId) {
            showConfirmDialog(
                'Supprimer le produit',
                'Êtes-vous sûr de vouloir supprimer ce produit du catalogue ?',
                () => {
                    const index = productCatalog.findIndex(p => p.id === productId);
                    if (index !== -1) {
                        productCatalog.splice(index, 1);
                        saveToLocalStorage();
                        renderCatalog();
                        showToast('Produit supprimé avec succès', 'warning');
                    }
                }
            );
        }

        function generateQRCode(productId) {
            const product = productCatalog.find(p => p.id === productId);
            
            if (!product) {
                showToast('Produit non trouvé', 'danger');
                return;
            }
            
            // Créer le contenu du QR code
            const qrContent = `Marque: ${product.brand}|Cigare: ${product.name}|Pays: ${product.country}|Prix: ${product.price.toFixed(2)}`;
            
            // URL pour générer un QR code via une API externe
            const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrContent)}`;
            
            // Créer une fenêtre pop-up avec le QR code
            const popupWindow = window.open('', '_blank', 'width=400,height=500');
            popupWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>QR Code - ${product.brand} ${product.name}</title>
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            text-align: center;
                            padding: 20px;
                        }
                        h2 {
                            margin-bottom: 5px;
                        }
                        p {
                            margin: 5px 0;
                            color: #666;
                        }
                        img {
                            margin: 20px 0;
                            max-width: 100%;
                        }
                        button {
                            background-color: #4CAF50;
                            border: none;
                            color: white;
                            padding: 10px 20px;
                            text-align: center;
                            text-decoration: none;
                            display: inline-block;
                            font-size: 16px;
                            margin: 10px 2px;
                            cursor: pointer;
                            border-radius: 4px;
                        }
                    </style>
                </head>
                <body>
                    <h2>${product.brand} - ${product.name}</h2>
                    <p>Pays: ${product.country}</p>
                    <p>Prix: ${product.price.toFixed(2)}€</p>
                    <img src="${qrCodeUrl}" alt="QR Code">
                    <br>
                    <button onclick="window.print()">Imprimer</button>
                </body>
                </html>
            `);
        }

        // Fonctions utilitaires
        function showToast(message, type = 'info') {
            // Créer l'élément toast
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} alert-toast`;
            toast.innerHTML = message;
            
            // Ajouter au DOM
            document.body.appendChild(toast);
            
            // Supprimer après 3 secondes
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function showConfirmDialog(title, message, callback) {
            const modalLabel = document.getElementById('confirmModalLabel');
            const modalBody = document.getElementById('confirmModalBody');
            const confirmBtn = document.getElementById('confirmModalBtn');
            
            modalLabel.textContent = title;
            modalBody.textContent = message;
            
            // Supprimer les anciens event listeners
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            // Ajouter le nouveau event listener
            newConfirmBtn.addEventListener('click', () => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
                modal.hide();
                callback();
            });
            
            // Afficher la modal
            const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
            modal.show();
        }
    </script>
</body>
</html>
